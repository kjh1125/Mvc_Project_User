<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko" th:with="page='boardDetail'">
<head th:replace="~{fragments/header :: head}"></head>
<body>

<div class="mobile-view">
    <div class="back-view">
        <div class="container">
            <!-- 뒤로가기 -->
            <div class="d-flex align-items-center mb-3">
                <a class="me-2 text-dark" th:href="@{/board/list}">
                    <i class="bi bi-arrow-left fs-4"></i>
                </a>
                <h4 class="m-0">게시판</h4>
            </div>

            <!-- 게시글 -->
            <div class="card p-3">
                <div class="d-flex align-items-center">
                    <img alt="프로필" class="profile-img me-2" th:src="@{/images/profile-icon/1.jpg}">
                    <div style="">
                        <strong th:text="${board.nickname}">하리보</strong>
                        <div class="dropdown">
                            <button aria-expanded="false" class="icon-button" data-bs-toggle="dropdown" type="button">
                                <i class="bi bi-three-dots-vertical"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <!-- 작성자만 수정/삭제 버튼이 보이도록 -->
                                <li id="editBtn" th:if="${session.user == board.writer_id}">
                                    <a class="dropdown-item" href="#" onclick="editPost()">
                                        <i class="bi bi-pencil-square"></i> 수정
                                    </a>
                                </li>
                                <!-- 작성자만 수정/삭제 버튼이 보이도록 -->
                                <li id="deleteBtn" th:if="${session.user == board.writer_id}">
                                    <a class="dropdown-item" href="#">
                                        <i class="bi bi-trash"></i> 삭제
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item"
                                       data-bs-target="#reportModal"
                                       data-bs-toggle="modal"
                                       href="#">
                                        <i class="bi bi-exclamation-triangle"></i> 신고
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <p class="mb-1" th:text="${board.title}">안녕하세요</p>
                        <small class="text-muted" th:text="${board.content}">안녕하세요! 오늘 가입했어요</small>
                    </div>
                </div>
                <div class="mt-2">
                    <button style="background: none; border: none; padding: 0;">
                        <i id="likeBtn" th:class="${checkLikeExists} ? 'bi bi-heart-fill' : 'bi bi-heart'"></i>
                    </button>
                    <span id="heartCount" th:text="${board.heart_count}">1</span>
                    <i class="bi bi-chat-dots"></i> <span th:text="${board.comment_count}">1</span>
                    <span class="ms-2 text-muted" th:text="${board.created_at}">25-02-05 16:06</span>
                </div>
            </div>

            <!-- 댓글 리스트로 받아와서 each 함수를 이용하여 출력-->
            <div class="comment-box mt-2" th:each="comment : ${commentList}">
                <div class="d-flex align-items-center">
                    <img alt="프로필" class="profile-img me-2" th:src="@{/images/profile-icon/1.jpg}">
                    <div>
                        <strong th:text="${comment.nickname}">치킨</strong>
                        <p class="mb-1" th:text="${comment.content}">안녕하세요!</p>
                        <small class="text-muted" th:text="${comment.createdAt}">25-02-05 16:18</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 댓글 입력창 -->
        <div class="input-box">
            <input class="form-control me-2" placeholder="댓글을 달아주세요" type="text">
            <button class="btn btn-primary">전송</button>
        </div>

        <!-- footer.html 포함 -->
        <div th:replace="fragments/footer.html :: footer"></div>
    </div>
</div>

<!-- 신고 창 모달 -->
<div aria-hidden="true" aria-labelledby="reportModalLabel" class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reportModalLabel">게시글 신고</h5>
                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <form id="reportForm">
                <div class="modal-body">
                    <p>이 게시글을 신고하시겠습니까?</p>
                    <div class="mb-3">
                        <label class="form-label" for="reportReason">신고 사유</label>
                        <select class="form-select" id="reportReason">
                            <option value="">신고 사유를 선택해주세요</option>
                            <option value="1">스팸</option>
                            <option value="2">욕설/비방</option>
                            <option value="3">음란물</option>
                            <option value="4">기타</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">취소</button>
                    <button class="btn btn-danger" type="submit">신고하기</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 알림창 모달 -->
<div aria-hidden="true" class="modal fade" id="alert" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">알림</h5>
            </div>
            <div class="modal-body">
                신고가 접수되었습니다.
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="confirmBtn" type="button">확인</button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    // 모델로 지정한 값 직접 가져오기
    const user_id = /*[[${session.user}]]*/ null; //세션에 있는 유저아이디 주입
    const board_id = [[${board.id}]]; //게시판 보드아이디
    //좋아요 버튼
    const likeBtn = document.querySelector('#likeBtn');
    //좋아요 카운트 범위 가져오기
    const heartCountSpan = document.getElementById("heartCount");
    //신고창에서 사용하는 요소
    const reportForm = document.getElementById('reportForm');
    const reportModal = document.getElementById('reportModal');
    //기본알림창으로 사용할 모달창
    let alert = new bootstrap.Modal(document.getElementById('alert'));
    //삭제 버튼
    const deleteBtn = document.querySelector('#deleteBtn');
    //수정 버튼
    const editBtn = document.querySelector('#editBtn');

    // DOMContentLoaded를 넣어서 DOM이 모두 Load된 후 해당 Action이 작동되도록 설정.
    document.addEventListener('DOMContentLoaded', function() {

        //좋아요 버튼 실행
        likeBtn.addEventListener('click', async function (e) {
        e.preventDefault(); // 기본 동작 방지

            try {
                const response = await fetch('/board/like', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json' // JSON 데이터임을 명시
                    },
                    body: JSON.stringify({
                        "user_id": user_id,
                        "board_id": board_id
                    })
                });

                if (response.ok) {
                    const data = await response.json(); // JSON 응답 받기
                    heartCountSpan.textContent = data.heartCount; // 좋아요 개수 업데이트

                    // 아이콘 클래스 토글
                    likeBtn.classList.toggle('bi-heart-fill',!data.liked);
                    likeBtn.classList.toggle('bi-heart',data.liked);
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        // 신고 모달 창 submit 시 작동하는 함수
        reportForm.addEventListener('submit', async (e) => {
        e.preventDefault(); // 기본 폼 제출 동작 방지

        const reason = document.getElementById('reportReason').value;
        const modal = bootstrap.Modal.getInstance(reportModal);

        if (!reason) {
            alert('신고 사유를 선택해주세요.');
            return;
        }

        try {
            const response = await fetch('./report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: user_id,
                    board_id: board_id,
                    reason_id: reason
                })
            });

            if (response.status === 409) {  // 중복 신고 (409 Conflict 응답)
                showAlert("이미 신고한 게시물입니다.");
                modal.hide();
            } else if (response.ok) {  // 성공적으로 신고됨 (200 OK 응답)
                showAlert("신고가 완료되었습니다.");
                modal.hide();

            } else {
                alert("오류가 발생했습니다. 다시 시도해주세요.");
            }
        } catch (error) {
            console.error('Error:', error);
            alert('신고 처리 중 오류가 발생했습니다.');
        }
        });

        //삭제 버튼 실행
        deleteBtn.addEventListener('click', async function (e) {
        e.preventDefault(); // 기본 동작 방지

            confirm("삭제하시겠습니까?");

            try {
                const response = await fetch('/board/delete?board_id='+board_id, {
                    method: 'delete'
                });
                if (response.ok) {
                    showAlert("삭제되었습니다.","/board/list");
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        //수정버튼 실행
        editBtn.addEventListener("click", function() {
            $.ajax({
                type: "POST",
                url: "/board/check-auth/" + board_id,
                success: function(response) {
                    if (response.authorized) {
                        location.href = "/board/edit/" + board_id;
                    } else {
                        showAlert("수정 권한이 없습니다.");
                    }
                },
                error: function() {
                    showAlert("권한 확인 중 오류가 발생했습니다.");
                }
            });
        });

        //알림창 함수, redirectUrl이 같이 오는 경우 확인 후 해당 Url로 이동.
        function showAlert(message, redirectUrl = null) {
            document.querySelector("#alert .modal-body").innerHTML = message;
            alert.show();
            document.getElementById('confirmBtn').addEventListener('click', function () {
                alert.hide();
                if (redirectUrl) {
                    location.href = redirectUrl; // 이동
                }
            });
        }
    });
</script>
</body>
</html>
