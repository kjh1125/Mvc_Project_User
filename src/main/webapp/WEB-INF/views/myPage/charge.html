<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <title>모바일 게시판</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">

    <style>
        .opener:hover{
            cursor: pointer;
        }
        .text-secondary {
            font-size: 0.8rem;
        }
        p{
            margin-bottom: 0.5rem;
        }
        input[type="number"] {
            -webkit-appearance: none;  /* Safari, Chrome에서 화살표 제거 */
            -moz-appearance: textfield; /* Firefox에서 화살표 제거 */
            appearance: none;           /* 표준화된 방법으로 화살표 제거 */
            padding: 0;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #purchase {
            border-radius:10px;
            background-color: #dddddd;
            color:#DB4747;
            width:70%
        }
        #purchase:hover{
            cursor: pointer;
        }

        #purchase.disabled{
            color: gray !important;
        }
        #purchase.disabled:hover{
            cursor: default;
        }
    </style>
</head>
<body>

<div class="mobile-view">
    <div class="back-view p-4">
        <div class="mb-2 d-flex align-items-center">
            <a th:href="@{/myPage}">
                <i class="fs-4 bi bi-arrow-left"></i>
            </a>
            <div class="ms-1 pt-1">
                포인트 충전
            </div>
        </div>
        <div class="ms-3">
            <div class="ms-1" style="font-size: 0.9rem;">
                충전할 포인트
            </div>
            <div class="fs-2 fw-bold border-bottom border-secondary d-flex justify-content-end pe-5">
                <input id="charge" class="d-none border-0 fw-bold" type="text" value="10000" style="text-align: right" onFocusout="formatInput()" />
                <div id="formatted-output" class="fs-2 fw-bold" onclick="handleChange(event)">12,345</div> <!-- 출력할 위치 -->
                <span>P</span>
            </div>
        </div>
        <div class="fs-5 mt-5 d-flex justify-content-center w-100 fw-bold" style="color:saddlebrown">
            충전하기
        </div>
        <div class="d-flex justify-content-end w-100 pe-4" style="color:lightslategray; font-size: 0.9rem">
            충전 비율: 100P = 1,000원
        </div>
        <div class="d-flex justify-content-between w-50 ps-3 pe-3 m-auto mt-3">
            <div>보유 포인트</div>
            <div>
            <span id="current-point" th:text="${point}">0</span><span>P</span>
            </div>
        </div>
        <div class="d-flex justify-content-between w-50 ps-3 pe-3 m-auto pb-5">
            <div>충전 후 포인트</div>
            <div>
            <span id="after-point">10000</span><span>P</span>
            </div>
        </div>
        <div class="d-flex justify-content-center m-auto w-100 mt-5">
            <div class="d-flex justify-content-center align-items-center p-4 fs-3 text-light" style="border-radius:10px; background-color: #DB4747; width:70%">
                <span id="money"></span>원
            </div>
        </div>
        <div class="d-flex justify-content-center m-auto w-100 mt-3">
            <div class="d-flex justify-content-center align-items-center p-1 fs-3" id="purchase">
                결제하기
            </div>
        </div>
        <div class="d-flex justify-content-center m-auto w-100">
            <span id="warn" class="fw-bold fs-5 text-danger"></span>
        </div>
    </div>
    <div th:replace="fragments/footer.html :: footer">

    </div>
</div>
<script>
    const $point = $('#current-point');
    const $afterPoint = $('#after-point');
    const $formatOutput = $('#formatted-output');
    const $chargeInput = $('#charge');
    const $money = $('#money');
    const $warn = $('#warn');
    const $purchase = $('#purchase');

    function formatInput() {
        let value = $chargeInput.val();
        if(value%1000!==0){
            alert("최소 입력단위는 1000입니다")
            $chargeInput.val($formatOutput.text());
            return;
        }
        if (!isNaN(value) && value !== "") {
            const afterValue = (parseInt(value) + parseInt($point.text())).toLocaleString();
            const moneyValue = (parseInt(value)/10).toLocaleString();
            value = Number(value).toLocaleString();
            $formatOutput.text(value);
            $afterPoint.text(afterValue);
            $money.text(moneyValue);
            if(value==='0'){
                alert("최소 결제금액은 100원입니다")
            }
        } else {
            $formatOutput.text('0');
            $afterPoint.text($point.text());
            $money.text('0');
            $warn.text('최소 결제금액은 100원 입니다.');
            $purchase.toggleClass('disabled',true);
        }
        $formatOutput.toggleClass("d-none");
        $chargeInput.toggleClass("d-none");
    }

    function handleChange(event) {
        const divText = event.target.textContent.replace(/,/g, '');
        const $inputField = $('#charge');
        const clickedIndex = getClickedIndex(divText, event.clientX, event.clientY);

        $inputField.removeClass('d-none');
        $formatOutput.addClass('d-none');

        if (clickedIndex !== -1) {
            setCursorPosition($inputField[0], clickedIndex);
        }
    }

    function getClickedIndex(clickedText, x, y) {
        const range = document.caretRangeFromPoint(x, y);
        return range ? range.startOffset : 0;
    }

    function setCursorPosition(inputField, index) {
        const inputLength = inputField.value.length;
        if (index >= 0 && index <= inputLength) {
            inputField.setSelectionRange(index, index);
            inputField.focus();
        } else {
            inputField.setSelectionRange(inputLength, inputLength);
            inputField.focus();
        }
    }

    $(document).ready(function() {
        formatInput();
    });

    $purchase.on('click', function() {
        if (!$purchase.prop('disabled')) {  // disabled 속성을 확인
            $.ajax({
                url: '/blindtime/user/charge',
                type: 'POST',
                data: { points: $chargeInput.val() },
                success: function(response) {
                    window.location.reload();
                },
                error: function(xhr, status, error) {
                    alert('오류 ' + error);
                }
            });
        }
    });

</script>
</body>
</html>
